<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>sergeytsaplin.com</title><link href="http://sergeytsaplin.com/" rel="alternate"></link><link href="http://sergeytsaplin.com/feeds/blog.atom.xml" rel="self"></link><id>http://sergeytsaplin.com/</id><updated>2013-05-17T01:00:00+03:00</updated><entry><title>Пагинация в Oracle</title><link href="http://sergeytsaplin.com/oracle-pagination/" rel="alternate"></link><updated>2013-05-17T01:00:00+03:00</updated><author><name>Sergey Tsaplin</name></author><id>tag:sergeytsaplin.com,2013-05-17:oracle-pagination/</id><summary type="html">&lt;p&gt;Как известно, БД от Oracle не поддерживает инструкцию &lt;code&gt;LIMIT&lt;/code&gt; в SQL-запросах. Поэтому на первых порах часто возникают вопросы, о том как реализовать пагинацию в Oracle. Тут на самом деле все просто. Достаточно использовать &lt;code&gt;rownum&lt;/code&gt;, например вот так:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;select&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;
&lt;span class="k"&gt;from&lt;/span&gt; &lt;span class="n"&gt;some_table&lt;/span&gt;
&lt;span class="k"&gt;where&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;some_conditions&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
   &lt;span class="k"&gt;and&lt;/span&gt; &lt;span class="n"&gt;rownum&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;
   &lt;span class="k"&gt;and&lt;/span&gt; &lt;span class="n"&gt;rownum&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="mi"&gt;20&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Казалось бы ВОТ ОНО. Но не тут то было. Как только возникает потребность реализовать пагинацию над некой агрегированной выборкой (выборка с использованием групповых функций), приходится выполнить ряд дополнительных телодвижений:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;select&lt;/span&gt; &lt;span class="n"&gt;tmp&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;
&lt;span class="k"&gt;from&lt;/span&gt;
  &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;select&lt;/span&gt; &lt;span class="n"&gt;field1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
          &lt;span class="k"&gt;count&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;field2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;field2_cnt&lt;/span&gt;
          &lt;span class="k"&gt;sum&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;field3&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;field3_sum&lt;/span&gt;
   &lt;span class="k"&gt;from&lt;/span&gt; &lt;span class="n"&gt;some_table&lt;/span&gt;
   &lt;span class="k"&gt;where&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;some_conditions&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
   &lt;span class="k"&gt;group&lt;/span&gt; &lt;span class="k"&gt;by&lt;/span&gt; &lt;span class="n"&gt;field1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;tmp&lt;/span&gt;
&lt;span class="k"&gt;where&lt;/span&gt; &lt;span class="n"&gt;rownum&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;
  &lt;span class="k"&gt;and&lt;/span&gt; &lt;span class="n"&gt;rownum&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="mi"&gt;20&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Что здесь происходит? Здесь сначала делается выборка по полям, удовлетворяющим условиям, выполняются групповые операции над ними, затем отсечку по rownum делаем уже над сгруппированными данными, таким образом пагинация работает, как и ожидалось. Вот такой вот небольшой хинт. Ну и всё это можно обернуть в некую хранимую функцию на pl/sql:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="k"&gt;function&lt;/span&gt; &lt;span class="n"&gt;get_padgination_cursor&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;page&lt;/span&gt; &lt;span class="k"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;integer&lt;/span&gt; &lt;span class="o"&gt;:=&lt;/span&gt; &lt;span class="mf"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;sys_ref_cursor&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt;
  &lt;span class="n"&gt;cr&lt;/span&gt; &lt;span class="n"&gt;sys_ref_cursor&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
  &lt;span class="n"&gt;records_per_page&lt;/span&gt; &lt;span class="nb"&gt;integer&lt;/span&gt; &lt;span class="o"&gt;:=&lt;/span&gt; &lt;span class="mf"&gt;20&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
  &lt;span class="n"&gt;start_limit&lt;/span&gt; &lt;span class="nb"&gt;integer&lt;/span&gt; &lt;span class="o"&gt;:=&lt;/span&gt; &lt;span class="n"&gt;records_per_page&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;page&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="mf"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="mf"&gt;1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
  &lt;span class="n"&gt;stop_limit&lt;/span&gt; &lt;span class="nb"&gt;integer&lt;/span&gt; &lt;span class="o"&gt;:=&lt;/span&gt; &lt;span class="n"&gt;start_limit&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;records_per_page&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;begin&lt;/span&gt;
  &lt;span class="k"&gt;open&lt;/span&gt; &lt;span class="n"&gt;cr&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt;
    &lt;span class="k"&gt;select&lt;/span&gt; &lt;span class="n"&gt;tmp&lt;/span&gt;&lt;span class="mf"&gt;.&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;
    &lt;span class="k"&gt;from&lt;/span&gt;
      &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;select&lt;/span&gt; &lt;span class="n"&gt;field1&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
              &lt;span class="n"&gt;count&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;field2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;field2_cnt&lt;/span&gt;
              &lt;span class="n"&gt;sum&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;field3&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;field3_sum&lt;/span&gt;
       &lt;span class="k"&gt;from&lt;/span&gt; &lt;span class="n"&gt;some_table&lt;/span&gt;
       &lt;span class="k"&gt;where&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;some_conditions&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
       &lt;span class="k"&gt;group&lt;/span&gt; &lt;span class="k"&gt;by&lt;/span&gt; &lt;span class="n"&gt;field1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="n"&gt;tmp&lt;/span&gt;
    &lt;span class="k"&gt;where&lt;/span&gt; &lt;span class="n"&gt;rownum&lt;/span&gt; &lt;span class="o"&gt;&amp;gt;=&lt;/span&gt; &lt;span class="n"&gt;start_limit&lt;/span&gt;
      &lt;span class="k"&gt;and&lt;/span&gt; &lt;span class="n"&gt;rownum&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt; &lt;span class="n"&gt;stop_limit&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

  &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;cr&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;end&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;</summary><category term="pl/sql"></category><category term="oracle"></category><category term="pagination"></category><category term="пагинация"></category></entry><entry><title>Авторизация в Redmine через ActiveDirectory с использованием ролей</title><link href="http://sergeytsaplin.com/redmine-ldap/" rel="alternate"></link><updated>2012-12-23T19:00:00+02:00</updated><author><name>Sergey Tsaplin</name></author><id>tag:sergeytsaplin.com,2012-12-23:redmine-ldap/</id><summary type="html">&lt;p&gt;Столкнулся недавно с, казалось бы, уже многократно пережеванной задачей - интеграцией Redmine и Active Directory, но с одни доп. условием - авторизация должна проходить только для пользователей из определенной группы в AD. Ну сказано - сделано. Поэтому, чтобы и самому не забыть, да и, вдруг, кому пригодиться, оставлю здесь пошаговую инструкцию.&lt;/p&gt;
&lt;p&gt;Для ясности договоримся, что домен у нас зовется domain.local&lt;/p&gt;
&lt;p&gt;Итак, первым делом, нам нужен служебный пользователь в AD с правами на чтение атрибутов всех пользователей домена (ну или отдельно взятой ОУшки). Сделать это несложно, пускай пользователя будут звать ldap_agent. Теперь в оснастке управления AD (пользователи и компьютеры) выбираем нужный домен/ОУшку, кликаем в меню Действия-&amp;gt;Делегирование управления, в визарде всё понятно без слов, поэтому пропущу этот момент. Итак, двигаемся далее. Теперь займемся непосредственно Redmine'ом. Тут тоже все просто. Администрирование -&amp;gt;Авторизация с помощью LDAP. Там добавляем новый способ аутентификации или правим уже существующий (если таковой имеется). Переходим в форму настройки аутентификации. Там пишем следующее:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="l-Scalar-Plain"&gt;Имя&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;ActiveDirectory&lt;/span&gt; &lt;span class="c1"&gt;# любое имя, идентифицирующее текущий способ аутентификации&lt;/span&gt;
&lt;span class="l-Scalar-Plain"&gt;Компьютер&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;dc.domain.local&lt;/span&gt; &lt;span class="c1"&gt;# имя (или IP) хоста, выполняющего роль контроллера домена&lt;/span&gt;
&lt;span class="l-Scalar-Plain"&gt;Порт&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;389&lt;/span&gt; &lt;span class="c1"&gt;# порт, на котором висит сервис LDAP на контроллере домена (для ActiveDirectory по умолчанию 389)&lt;/span&gt;
&lt;span class="l-Scalar-Plain"&gt;Учётная запись&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;domain\ldap_agent&lt;/span&gt; &lt;span class="c1"&gt;# учетная запись в домене, под которой будем коннектиться к контроллеру и аутентифицировать пользователя (данному пользователю должны быть выданы права на чтение всех атрибутов всех пользователей домена или ОУшки, для которой должна работать авторизация)&lt;/span&gt;
&lt;span class="l-Scalar-Plain"&gt;Пароль&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;long_secret&lt;/span&gt; &lt;span class="c1"&gt;# пароль вышеуказанной учетной записи&lt;/span&gt;
&lt;span class="l-Scalar-Plain"&gt;BaseDN&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;dc=domain, dc=local&lt;/span&gt; &lt;span class="c1"&gt;# базовые параметры домена (и/или ОУшки в этом случае в начале строке следует дописать еще примерно вот это: ou=ouName,...)&lt;/span&gt;
&lt;span class="l-Scalar-Plain"&gt;Фильтр LDAP&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;(&amp;amp;(objectClass=user)(memberOf=cn=RedmineUsers, ou=LocDomainGroups, dc=domain, dc=local))&lt;/span&gt; &lt;span class="c1"&gt;# Фильтр, позволяющий реализовать более гибкую систему авторизации, например, авторизовать пользователя только при наличии определенной роли. В качестве примера, пускаем только пользователей из группы ReadmineUsers, которая, в свою очередь, находится в ОУшке LocDomainGroups.&lt;/span&gt;
&lt;span class="l-Scalar-Plain"&gt;Таймаут в секундах&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt;  &lt;span class="c1"&gt;# время ожидания ответа от контроллера - оставим пустым (и пусть весь мир подождет))))&lt;/span&gt;
&lt;span class="l-Scalar-Plain"&gt;Создание пользователя на лету&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;true&lt;/span&gt; &lt;span class="c1"&gt;# позволяет автоматически создавать пользователя при его первой успешной авторизации&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;В разделе формы с атрибутами настраиваем соответствие атрибутов пользователя в Redmine к атрибутам пользователя в AD:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="l-Scalar-Plain"&gt;Пользователь&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;sAMAccountName&lt;/span&gt; &lt;span class="c1"&gt;# наименование атрибута в LDAP, с которым будет сравниваться логин пользователя&lt;/span&gt;
&lt;span class="l-Scalar-Plain"&gt;Имя&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;givenName&lt;/span&gt; &lt;span class="c1"&gt;# наименование атрибута в LDAP, из которого будет автоматически подтягиваться имя пользователя в Redmine&lt;/span&gt;
&lt;span class="l-Scalar-Plain"&gt;Фамилия&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;sn&lt;/span&gt; &lt;span class="c1"&gt;# наименование атрибута в LDAP, из которого будет автоматически подтягиваться фамилия пользователя в Redmine&lt;/span&gt;
&lt;span class="l-Scalar-Plain"&gt;email&lt;/span&gt;&lt;span class="p-Indicator"&gt;:&lt;/span&gt; &lt;span class="l-Scalar-Plain"&gt;mail&lt;/span&gt; &lt;span class="c1"&gt;# наименование атрибута в LDAP, из которого будет автоматически подтягиваться email пользователя в Redmine&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Вот, собственно, и всё. Да, чуть не забыл. Этот способ был опробован на Redmine версии 2.1, в более ранних версиях не было возможности задавать дополнительные LDAP-фильтры&lt;/p&gt;</summary><category term="Redmine"></category><category term="LDAP"></category><category term="ActiveDirectory"></category><category term="Roles"></category><category term="Authorization"></category></entry></feed>